# Node 中错误处理
---

原文地址：[https://www.joyent.com/node-js/production/design/errors](https://www.joyent.com/node-js/production/design/errors)

在说说 Node 中错误处理之前先解析一下什么是错误，什么是异常

## 错误与异常

错误是由于系统资源而发生的情形，它不能由程序代码处理，无法以任何方式恢复错误，因为无法创建、抛出、捕获和回复错误；错误总是在运行环境中发生；

异常是由代码错误引起的，异常能够由程序本身处理，因为异常是可恢复的，通常使用 try、catch、throw 来处理异常；

## Node.js 中错误处理

错误处理是一种痛苦，在长时间使用 Node.js 的过程中很容易不被正确处理。但是构建健壮的 Node.js 应用需要我们正确的处理错误。

下面主要从以下几个问题进行入手：

 * 在代码中何时抛出错误，何时使用回调、事件发生器或其它方式处理错误？
 * 是否应该判断函数是否有参数，参数是什么类型，或者是否应该对参数进行约束？
 * 如何处理与函数期望的参数不同的参数？应该回调还是抛出错误？
 * 如果以代码的方式区分不同类型的错误，如“错误请求”错误与“服务不可用”错误？
 * 是否应该对我的代码提供足够的错误李信息，是的调用者能出更好的处理？
 * 如何处理意外错误，使用 try/catch 还是别的什么？

### 执行错误与程序错误

处理错误之前区分执行错误还是程序错误是非常有必要的

* 执行错误: 执行错误表示正确编写的代码正常运行时遇到问题，这些问题不是程序中的错误，这些错误通常为系统错误、系统配置错误、网络错误等，有下面几种形似：
    * 服务器连接错误
    * 域名解析错误
    * 用户输入无效的内容
    * 请求超时
    * 服务器返回 500
    * 网络挂起
    * 内存溢出
* 程序错误: 程序错误是代码 bug，通过更改代码能够避免这些问题，但是有些情况不能处理，比如下面的情况:
    * 读取一个为 undefined 属性的值
    * 调用一个异步函数没有回调
    * 期望一个对象，但是得到一个字符串
    * 期望一个 ip 地址，但是得到一个对象

人们常常使用错误来统称执行错误和程序错误，但是它们完全不同。操作错误是所有正确程序必须被处理，它们不一定表示错误甚至是严重错误，如“找不到文件”是一个执行错误，但是这并不一定意味者任何错误，可能只是意味者程序必须先创建它正在寻找的文件。

通过对比执行错误和程序错误可以发现，程序错误是bug，程序错误是在写代码过程中犯的错误，比如你忘记对输入进行了校验。但是根据执行错误和程序错误的定义没有方法处理，如果有，那应该使用对错误的代码进行错误处理。

区分执行错误和程序错误是非常重要的，执行错误是正常运行的一部分，程序错误是错误。

有时，你可能将执行错误和程序错误作为一类问题。如果一个 HTTP 服务器使用了一个未知的变量导致崩溃，这是一个程序错误；当客户端请求连接是出现 "ECONNREST" 错误时，这是一个执行错误，因为正确的客户端必须处理崩溃的服务器。

同样，未处理执行错误本身就是程序错误，如，如果一个程序尝试连接到服务器，但是收到拒绝连接的响应，并且没有为拒绝连接事件添加错误处理，程序将奔溃，者时程序错误，因为连接失败是一个执行错误，但是处理失败是程序错误。

执行错误和程序错误之间的区别是确定如何交付错误以及处理错误，这是正确处理错误的前提。

### 处理执行错误

就像性能和安全性一样，错误处理不能绑定到已经没有错误处理的程序上，你也不能将所有错误处理集中在程序的一个部分，就像不能将"性能处理"集中在程序的一个部分一样，任何可能失败的代码（打开文件、连接服务处、处理字进程等）都必须考虑当该操作失败时会发生什么，这必须包括知道它可能何时会失败以及什么样的失败代表什么样的错误，错误处理的关键是必须以粒度的方式进行完成，因为影响和响应取决于什么样的失败和为什么失败。

你可能会在堆栈的多个级别处理相同的错误。当较低级别的调用者无法执行任何有用的操作时，会将错误传递给它的调用者，通常，只有顶级调用者知道知道返回怎样的响应，是重试操作、想用户报错错误还是其它内容，但是这并不意味着你应该将所有的错误都报告给顶级传送调用者，因为顶级调用者可能无法知道错误发生在什么上下文中，哪些操作已经成功完成，哪些操作实际上是失败的。

### 处理程序错误

